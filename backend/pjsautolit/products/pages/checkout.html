<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link rel="icon" type="image/png" href="https://i.postimg.cc/VkGmFmx1/Untitled-design-2.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- If using jQuery -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        :root {
            --primary-color: #0056b3;
            --secondary-color: #f8f9fa;
            --accent-color: #dc3545;
            --text-color: #333;
            --light-gray: #e9ecef;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
        }

        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--secondary-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex-grow: 1;
        }

        .navbar-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .navbar {
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .logo img {
            height: 80px;
        }

        .contact-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }

        .phone-number, .email {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #333;
            font-size: 16px;
            font-weight: 500;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-links a {
            text-decoration: none;
            color: #333;
            font-size: 18px;
        }

        .cart-icon {
            position: relative;
        }

        .cart-icon i {
            font-size: 20px;
            color: #333;
        }

        .cart-count {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
        }

        .menu-icon {
            display: none;
            font-size: 24px;
            cursor: pointer;
            z-index: 1002;
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100vh;
            background-color: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            transition: left 0.3s ease;
            z-index: 1001;
            padding-top: 60px;
        }

        .mobile-menu.active {
            left: 0;
        }

        .mobile-menu .nav-links {
            display: flex !important;
            flex-direction: column;
            padding: 20px;
            gap: 15px;
        }

        .close-menu {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
        }

        .mobile-contact-info {
            display: none;
            padding: 10px 20px;
            background-color: #f8f9fa;
            border-top: 1px solid #eee;
        }

        @media (max-width: 968px) {
            .navbar {
                padding: 10px 15px;
            }

            .navbar-wrapper {
                display: flex;
                flex-direction: column;
            }

            .logo img {
                height: 50px;
            }

            .nav-links:not(.mobile-menu .nav-links) {
                display: none;
            }

            .menu-icon {
                display: block;
            }

            .contact-info {
                display: none;
            }

            .mobile-contact-info {
                display: flex;
                justify-content: space-around;
                flex-direction: row;
                gap: 8px;
            }

            /* Top row layout */
            .navbar {
                display: grid;
                grid-template-columns: auto 1fr auto;
                align-items: center;
                gap: 15px;
            }

            .menu-icon {
                grid-column: 1;
            }

            .logo-container {
                grid-column: 2;
                justify-content: center;
            }

            .user-actions {
                grid-column: 3;
            }

            /* Mobile menu styles */
            .mobile-menu {
                display: block;
            }

            .mobile-menu .nav-links a {
                display: block;
                padding: 10px 0;
                font-size: 16px;
                border-bottom: 1px solid #eee;
            }

            /* Contact info styles */
            .phone-number, .email {
                font-size: 14px;
                justify-content: center;
                width: 100%;
            }

            .cart-icon i {
                font-size: 18px;
            }

            .cart-count {
                top: -8px;
                right: -8px;
                padding: 1px 5px;
            }
        }

        .checkout-content {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 40px;
            margin-top: 100px;
        }

        h1 {
            font-size: 36px;
            font-weight: 900;
            margin-bottom: 20px;
            color: var(--primary-color);
            text-align: center;
        }

        .summary {
            margin-bottom: 30px;
        }

        .summary h3 {
            font-size: 24px;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .list-group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--light-gray);
        }

        .list-group-item:last-child {
            border-bottom: none;
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s;
            border: none;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 20px;
        }

        .btn:hover {
            background-color: var(--accent-color);
        }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #card-container {
            border: 1px solid var(--light-gray);
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 5px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }

        .info-button {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
        }

        .info-button:hover {
            color: var(--accent-color);
        }

        /* Toast and Loading Styles */
        .toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1060;
    max-width: 350px;
}

.toast {
    background-color: #FFFFFF;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border: 1px solid #E0E0E0;
    padding: 12px 16px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
}

.toast.show {
    opacity: 1;
    transform: translateX(0);
}

.toast-icon {
    margin-right: 12px;
    display: flex;
    align-items: center;
}

.toast-icon i {
    font-size: 20px;
}

.toast-content {
    flex-grow: 1;
}

.toast-message {
    color: #333;
    font-size: 14px;
    line-height: 1.4;
}

.toast-close {
    background: none;
    border: none;
    color: #888;
    cursor: pointer;
    font-size: 18px;
    padding: 0;
    margin-left: 12px;
    line-height: 1;
}

.toast-close:hover {
    color: #333;
}

/* Specific toast types */
.toast-error {
    border-left: 4px solid #FF4D4F;
}

.toast-success {
    border-left: 4px solid #52C41A;
}

.toast-info {
    border-left: 4px solid #1890FF;
}

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1050;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #0056b3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        footer {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 20px 0;
            margin-top: auto;
        }

        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                padding: 10px;
            }
            .nav-links {
                margin-top: 10px;
            }
            .logo {
                margin-left: 0;
            }
            .toast {
                width: 90%;
                margin: 0 auto;
            }
        }
        form input, form select, form textarea {
    width: 100%;
    padding: 12px 15px;
    margin: 10px 0;
    display: inline-block;
    border: 1px solid var(--light-gray);
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    font-size: 16px;
    font-family: 'Roboto', sans-serif;
    color: var(--text-color);
    transition: border-color 0.3s, box-shadow 0.3s;
}

form input:focus, form select:focus, form textarea:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 5px var(--primary-color);
    outline: none;
}

form label {
    font-size: 14px;
    font-weight: bold;
    color: var(--text-color);
    margin-bottom: 5px;
    display: block;
}

form .invalid-feedback {
    font-size: 12px;
    color: var(--accent-color);
    margin-top: 5px;
    display: none;
}

form .invalid-feedback.visible {
    display: block;
}

.row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
}

.col-md-6 {
    flex: 1;
    min-width: 48%;
}

.col-md-4 {
    flex: 1;
    min-width: 30%;
}

.col-md-2 {
    flex: 1;
    min-width: 15%;
}

/* Responsive Design */
@media (max-width: 768px) {
    .row .col-md-6, .row .col-md-4, .row .col-md-2 {
        min-width: 100%;
    }
}
.error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .is-invalid {
            border-color: #dc3545 !important;
        }

        .error-message.show {
            display: block;
        }
        .price-details {
    display: flex;
    align-items: center;
}

.original-price {
    font-size: 0.9em;
    color: #888;
    text-decoration: line-through;
}

.discounted-price {
    font-weight: bold;
    color: #007bff;
    margin-left: 10px;
}

.discount-details {
    margin-top: 5px;
}

.discount-details small {
    display: block;
    color: #28a745;
}

.discount-details .fas.fa-tag {
    margin-right: 5px;
    color: #ffc107;
}
#buttons-container{
    background-color: blue;
}
.buttons-container{
    background-color: blue;

}
#paypal-button-container {
    margin: 3rem auto 0;
    max-width: 500px;
    display: flex;
    justify-content: center;
}
    </style>

</head>
<body>
<div class="container">
    <div class="navbar-wrapper">
        <nav class="navbar">
            <div class="menu-icon">
                <i class="fas fa-bars"></i>
            </div>
            <div class="logo-container">
                <div class="logo">
                    <a href="/" class="navbar-brand">
                        <img src="https://i.postimg.cc/h47H7Tcf/header-1.gif" alt="Logo">
                    </a>
                </div>
            </div>
            <div class="contact-info">
                <div class="phone-number">
                    <i class="fas fa-phone"></i>
                    <span>319-345-6760</span>
                </div>
                <div class="email">
                    <i class="fas fa-envelope"></i>
                    <span>pjsautolit@aol.com</span>
                </div>
            </div>
            <div class="nav-links">
                <a href="{% url 'landing_page' %}#top" id="home-link">Home</a>
           <a href="{% url 'landing_page' %}#show-schedule" class="nav-link">Show Schedule</a>
           <a href="/product/" class="nav-link">Products</a>
           <a href="{% url 'landing_page' %}#auto-links" class="nav-link">Auto Links</a>
           <a href="{% url 'landing_page' %}#about-us" class="nav-link">About Us</a>
           <a href="/terms/" class="nav-link">Terms</a>
           <a href="#" class="nav-link">Contact</a>
            </div>
            <div class="user-actions">
                <div class="cart-icon">
                    <a href="/cart/" class="nav-link">
                        <i class="fas fa-shopping-cart"></i>
                    </a>
                    <span class="cart-count">{{cart_count}}</span>
                </div>
            </div>
        </nav>
        <div class="mobile-contact-info">
            <div class="phone-number">
                <i class="fas fa-phone"></i>
                <span>319-345-6760</span>
            </div>
            <div class="email">
                <i class="fas fa-envelope"></i>
                <span>pjsautolit@aol.com</span>
            </div>
        </div>
    </div>

    <div class="mobile-menu">
        <div class="close-menu">
            <i class="fas fa-times"></i>
        </div>
        <div class="nav-links">
             <a href="{% url 'landing_page' %}#top" id="home-link">Home</a>
           <a href="{% url 'landing_page' %}#show-schedule" class="nav-link">Show Schedule</a>
           <a href="/product/" class="nav-link">Products</a>
           <a href="{% url 'landing_page' %}#auto-links" class="nav-link">Auto Links</a>
           <a href="{% url 'landing_page' %}#about-us" class="nav-link">About Us</a>
           <a href="/terms/" class="nav-link">Terms</a>
           <a href="#" class="nav-link">Contact</a>
        </div>
    </div>
    <div class="checkout-content">
        <h1>Checkout</h1>
        
        <!-- Shipping Information Form -->
        <div class="shipping-info mb-4">
            <h3>Shipping Information</h3>
            <form id="shipping-form" class="needs-validation" novalidate>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="first_name">First Name *</label>
                        <input type="text" class="form-control" id="first_name" name="first_name" required>
                        <div class="error-message" id="first_name-error"></div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="last_name">Last Name *</label>
                        <input type="text" class="form-control" id="last_name" name="last_name" required>
                        <div class="error-message" id="last_name-error"></div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="email">Email *</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                        <div class="error-message" id="email-error"></div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="phone">Phone *</label>
                        <input type="tel" class="form-control" id="phone" name="phone" required>
                        <div class="error-message" id="phone-error"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="address_line1">Address Line 1 *</label>
                    <input type="text" class="form-control" id="address_line1" name="address_line1" required>
                    <div class="error-message" id="address_line1-error"></div>
                </div>

                <div class="mb-3">
                    <label for="address_line2">Address Line 2</label>
                    <input type="text" class="form-control" id="address_line2" name="address_line2">
                    <div class="error-message" id="address_line2-error"></div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="city">City *</label>
                        <input type="text" class="form-control" id="city" name="city" required>
                        <div class="error-message" id="city-error"></div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="state">State *</label>
                        <select class="form-control" id="state" name="state" required>
                            <option value="">Select State</option>
                            <!-- Add state options here -->
                        </select>
                        <div class="error-message" id="state-error"></div>
                    </div>
                    <div class="col-md-2 mb-3">
                        <label for="postal_code">ZIP *</label>
                        <input type="text" class="form-control" id="postal_code" name="postal_code" required>
                        <div class="error-message" id="postal_code-error"></div>
                    </div>
                    <input type="hidden" name="country" value="United States">
                </div>
            </form>
        </div>

        <!-- Order Summary -->
        <div class="order-summary">
            <h3>Order Summary</h3>
            <ul class="list-group">
                {% for item in detailed_cart_items %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <h5>{{ item.item.product.title }}</h5>
                        <small class="text-muted">Product ID: {{ item.item.product.item_id }}</small>
                        <small class="text-muted d-block">Quantity: {{ item.item.quantity }}</small>
                        
                        <!-- Price and Discount Display -->
                        <div class="price-details">
                            {% if item.discounts %}
                            <span class="original-price" style="text-decoration: line-through; color: #888;">
                                ${{ item.original_price|floatformat:2 }}
                            </span>
                            <span class="discounted-price" style="color: #007bff; margin-left: 10px;">
                                ${{ item.per_unit_price|floatformat:2 }}
                            </span>
                            {% endif %}
                            
                            <!-- Discount Details -->
                            {% if item.discounts %}
                            <div class="discount-details mt-1">
                                {% for discount in item.discounts %}
                                <small class="text-success">
                                    <i class="fas fa-tag"></i> 
                                    {{ discount.name }}: 
                                    {{ discount.value }} off 
                                    (-${{ discount.amount|floatformat:2 }})
                                </small>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <span class="price">
                        ${{ item.final_subtotal|floatformat:2 }}
                    </span>
                </li>
                {% endfor %}
                
                <!-- Discount Summary -->
                <li class="list-group-item">
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Product Discounts</span>
                        <strong class="text-success">-${{ total_product_discount|floatformat:2 }} </strong>
                    </li>
                    {% if total_cart_discount > 0 %}
                    <div class="d-flex justify-content-between mt-2">
                        <span>Cart Discounts</span>
                        <strong class="text-success">-${{ total_cart_discount|floatformat:2 }}</strong>
                    </div>
                    {% endif %}
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span>Total Weight</span>
                    <strong>{{ total_weight_major }} lb {{ total_weight_minor }} oz</strong>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span>Subtotal (USD)</span>
                    <strong>${{ cart_total }}</strong>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <div>
                        <span>Shipping Cost</span>
                        <button type="button" class="info-button" onclick="showModal()">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>
                    <strong>+${{ shipping_cost }}</strong>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                    <span>Total (Including Shipping)</span>
                    <strong>${{ total_including_shipping }}</strong>
                </li>
            </ul>
        </div>

        <!-- Payment Form -->
        <div class="payment-section mt-4">
            <h3>Payment Information</h3>
            <form id="payment-form">
                {% csrf_token %}
                <div id="card-container" class="mb-3"></div>
                <button id="card-button" type="button" class="btn btn-primary btn-lg w-100">
                    Pay ${{ total_including_shipping }}
                </button>
                <div id="paypal-button-container"></div>
<p id="result-message"></p>
            </form>
            
    
        </div>
    </div>
</div>

<!-- Shipping Info Modal -->
<div id="shippingInfoModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Shipping Cost Calculation</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Here's how your shipping cost is calculated:</p>
                <ul>
                    <li><strong>First pound (1 lb): </strong>$4.65</li>
                    <li><strong>Each additional pound: </strong> $0.75</li>
                    <li><strong>Packaging charges: </strong> $2.00</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

<!-- Loading Overlay -->
<div class="loading-overlay d-none" id="loadingOverlay">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
<script
            src="https://www.paypal.com/sdk/js?client-id=AcB615AZVM5gbnUlutUVElQZ8XO5uE8_WluA4JQFZ0L61hxxLcZpXNeVlaCWbWwGxjSzrzArGYlu0bFf&buyer-country=US&currency=USD&components=buttons"
            data-sdk-integration-source="developer-studio"
        ></script>
<script src="https://web.squarecdn.com/v1/square.js"></script>

<!-- <script src="https://sandbox.web.squarecdn.com/v1/square.js"></script> -->

<script>
    document.querySelector('.menu-icon').addEventListener('click', function() {
            document.querySelector('.mobile-menu').classList.add('active');
        });

        document.querySelector('.close-menu').addEventListener('click', function() {
            document.querySelector('.mobile-menu').classList.remove('active');
        });

    window.paypal.Buttons({
    style: {
        shape: "rect",
        layout: "vertical",
        color: "blue",
        label: "pay",
    },
    
    async createOrder() {
        try {
            showLoading();
            
            // Validate shipping form first
            if (!validateShippingForm()) {
                hideLoading();
                showToast('Please fill in all required shipping information.', 'error');
                return;
            }

            // Process shipping form
            const shippingData = await processShippingForm();
            if (!shippingData.success) {
                hideLoading();
                showToast('Error saving shipping information.', 'error');
                return;
            }

            const response = await fetch("/api/orders/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to create order');
            }

            const orderData = await response.json();
            return orderData.id;

        } catch (error) {
            hideLoading();
            console.error('PayPal create order error:', error);
            showToast(error.message || 'Could not initiate PayPal Checkout', 'error');
            throw error;
        }
    },

    async onApprove(data, actions) {
        try {
            showLoading();

            const response = await fetch(`/api/orders/${data.orderID}/capture/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            const captureData = await response.json();

            if (captureData.success) {
                showToast('Payment successful!', 'success');
                setTimeout(() => {
                    window.location.href = `/order-confirmation/${captureData.order_id}/`;
                }, 2000);
            } else {
                throw new Error(captureData.error || 'Payment capture failed');
            }
        } catch (error) {
            console.error('PayPal capture error:', error);
            showToast(error.message || 'Payment processing failed', 'error');
        } finally {
            hideLoading();
        }
    },

    onCancel() {
        showToast('PayPal checkout cancelled', 'info');
    },
    
    onError(err) {
        hideLoading();
        console.error('PayPal error:', err);
        showToast('An error occurred with PayPal. Please try again.', 'error');
    }

}).render("#paypal-button-container");


    const US_STATES = [
    { value: 'AL', label: 'Alabama' },
    { value: 'AK', label: 'Alaska' },
    { value: 'AZ', label: 'Arizona' },
    { value: 'AR', label: 'Arkansas' },
    { value: 'CA', label: 'California' },
    { value: 'CO', label: 'Colorado' },
    { value: 'CT', label: 'Connecticut' },
    { value: 'DE', label: 'Delaware' },
    { value: 'DC', label: 'District of Columbia' },
    { value: 'FL', label: 'Florida' },
    { value: 'GA', label: 'Georgia' },
    { value: 'HI', label: 'Hawaii' },
    { value: 'ID', label: 'Idaho' },
    { value: 'IL', label: 'Illinois' },
    { value: 'IN', label: 'Indiana' },
    { value: 'IA', label: 'Iowa' },
    { value: 'KS', label: 'Kansas' },
    { value: 'KY', label: 'Kentucky' },
    { value: 'LA', label: 'Louisiana' },
    { value: 'ME', label: 'Maine' },
    { value: 'MD', label: 'Maryland' },
    { value: 'MA', label: 'Massachusetts' },
    { value: 'MI', label: 'Michigan' },
    { value: 'MN', label: 'Minnesota' },
    { value: 'MS', label: 'Mississippi' },
    { value: 'MO', label: 'Missouri' },
    { value: 'MT', label: 'Montana' },
    { value: 'NE', label: 'Nebraska' },
    { value: 'NV', label: 'Nevada' },
    { value: 'NH', label: 'New Hampshire' },
    { value: 'NJ', label: 'New Jersey' },
    { value: 'NM', label: 'New Mexico' },
    { value: 'NY', label: 'New York' },
    { value: 'NC', label: 'North Carolina' },
    { value: 'ND', label: 'North Dakota' },
    { value: 'OH', label: 'Ohio' },
    { value: 'OK', label: 'Oklahoma' },
    { value: 'OR', label: 'Oregon' },
    { value: 'PA', label: 'Pennsylvania' },
    { value: 'RI', label: 'Rhode Island' },
    { value: 'SC', label: 'South Carolina' },
    { value: 'SD', label: 'South Dakota' },
    { value: 'TN', label: 'Tennessee' },
    { value: 'TX', label: 'Texas' },
    { value: 'UT', label: 'Utah' },
    { value: 'VT', label: 'Vermont' },
    { value: 'VA', label: 'Virginia' },
    { value: 'WA', label: 'Washington' },
    { value: 'WV', label: 'West Virginia' },
    { value: 'WI', label: 'Wisconsin' },
    { value: 'WY', label: 'Wyoming' }
];
let paymentClickCount = 0;
const paymentComments = [
    "Your passion for PJ's Auto Literature is truly inspiring!",
    "Exploring the world of automotive knowledge with PJ's collection.",
    "Another automotive enthusiast expanding their literary horizons!",
    "Discovering automotive insights through PJ's carefully curated library.",
    "Fueling your mind with PJ's exceptional automotive literature.",
    "Navigating the world of auto expertise, one book at a time.",
    "Expanding automotive knowledge through PJ's comprehensive collection.",
    "Accelerating your understanding with PJ's unique literary resources.",
    "Driving deeper into automotive insights with PJ's literature.",
    "Unlocking automotive wisdom through PJ's exceptional publications.",
    "Exploring the intersection of automotive technology and storytelling.",
    "Enriching your automotive knowledge with PJ's carefully selected titles.",
    "Journeying through automotive history with PJ's remarkable collection.",
    "Expanding your automotive expertise, page by page.",
    "Connecting with automotive culture through PJ's literature.",
    "Transforming automotive passion into knowledge.",
    "Discovering the stories behind automotive innovation.",
    "Your commitment to automotive learning is remarkable!",
    "Exploring automotive excellence through thoughtful literature.",
    "Bridging automotive passion and intellectual curiosity."
];
    let payments;
    let card;
    
    async function initializeSquare() {
        payments = Square.payments('{{ square_application_id }}', '{{ square_location_id }}');
        card = await payments.card();
        await card.attach('#card-container');
    }

    async function handlePayment(event) {
    event.preventDefault();
    
    // Increment click count
    paymentClickCount++;
    
    // Disable the button to prevent multiple submissions
    const cardButton = document.getElementById('card-button');
    cardButton.disabled = true;
    
    // Select a comment based on click count (cycling through array)
    const commentIndex = (paymentClickCount - 1) % paymentComments.length;
    const dynamicComment = paymentComments[commentIndex];
    
    // Show toast with dynamic comment and click count
    if (paymentClickCount>=2){
    showToast(
        `(${paymentClickCount}x) ${dynamicComment}`, 
        'info'
    );
    }
    
    try {
        // Validate shipping form first
        if (!validateShippingForm()) {
            cardButton.disabled = false;
            showToast('Please fill in all required shipping information.', 'error');
            return;
        }

        // Process shipping form
        const shippingData = await processShippingForm();
        if (!shippingData.success) {
            cardButton.disabled = false;
            showToast('Error saving shipping information.', 'error');
            return;
        }

        // Get payment token
        const result = await card.tokenize();
        if (result.status === 'OK') {
            // Process payment
            const response = await fetch('/process-payment/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    sourceId: result.token
                })
            });

            const paymentResult = await response.json();
            if (paymentResult.success) {
                showToast('Payment successful!', 'success');
                setTimeout(() => {
                    window.location.href = `/order-confirmation/${paymentResult.order_id}/`;
                }, 2000);
            } else {
                throw new Error(paymentResult.error || 'Payment processing failed');
            }
        } else {
            throw new Error(result.errors[0].message);
        }
    } catch (error) {
        console.error('Payment error:', error);
        showToast(error.message || 'Payment processing failed.', 'error');
    } finally {
        hideLoading();
        cardButton.disabled = false;
    }
}

    async function processShippingForm() {
    const form = document.getElementById('shipping-form');
    const formData = {};
    
    const fields = form.querySelectorAll('input, select');
    fields.forEach(field => {
        formData[field.name] = field.value;
    });
    
    try {
        const response = await fetch('/checkout/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(formData)
        });

        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server returned non-JSON response');
        }

        const data = await response.json();
        console.log('Shipping form response:', data);
        
        if (!data.success && data.errors) {
            // Clear previous errors
            const errorElements = document.querySelectorAll('.error-message');
            errorElements.forEach(el => el.textContent = '');
            
            // Display validation errors
            Object.keys(data.errors).forEach(field => {
                const errorElement = document.getElementById(`${field}-error`);
                if (errorElement) {
                    errorElement.textContent = data.errors[field].join(' ');
                    errorElement.classList.add('show');
                }
            });
            return { success: false };
        }
        
        return data;
    } catch (error) {
        console.error('Error processing shipping form:', error);
        showToast('Error saving shipping information. Please try again.', 'error');
        return { success: false };
    }
}
    // Previous Square initialization code remains the same

    function validateShippingForm() {
    const form = document.getElementById('shipping-form');
    const fields = form.querySelectorAll('input, select');
    let isValid = true;

    fields.forEach(field => {
        if (!validateField(field)) {
            isValid = false;
        }
    });

    return isValid;
}
    function showModal() {
        $('#shippingInfoModal').modal('show');
    }

    function showLoading() {
        document.getElementById('loadingOverlay').classList.remove('d-none');
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').classList.add('d-none');
    }
    async function verifyUSAddress(address) {
    // This is a placeholder for address verification service integration
    // You would typically integrate with a service like USPS, SmartyStreets, or similar
    return {
        isValid: true,
        standardized: {
            address_line1: address.address_line1,
            address_line2: address.address_line2,
            city: address.city,
            state: address.state,
            postal_code: address.postal_code
        }
    };
}
function showToast(message, type = 'info', duration = 3000) {
    const toastContainer = document.getElementById('toastContainer');
    
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    
    // Determine icon based on type
    const iconMap = {
        'error': '<i class="fas fa-exclamation-circle" style="color: #FF4D4F;"></i>',
        'success': '<i class="fas fa-check-circle" style="color: #52C41A;"></i>',
        'info': '<i class="fas fa-info-circle" style="color: #1890FF;"></i>'
    };
    
    toast.innerHTML = `
        <div class="toast-icon">${iconMap[type] || iconMap['info']}</div>
        <div class="toast-content">
            <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="this.closest('.toast').remove()">&times;</button>
    `;
    
    // Add to container
    toastContainer.appendChild(toast);
    
    // Trigger show animation
    requestAnimationFrame(() => {
        toast.classList.add('show');
    });
    
    // Auto-remove after duration
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, duration);
}

// Example usage
document.addEventListener('DOMContentLoaded', () => {
    // You can keep the existing initialization code
    window.showToast = showToast;
});
    function validateField(field) {
    const errorElement = document.getElementById(`${field.id}-error`);
    let isValid = true;
    let errorMessage = '';

    switch (field.id) {
        case 'phone':
            const phoneValue = field.value.replace(/\D/g, '');
            if (phoneValue.length !== 10) {
                isValid = false;
                errorMessage = 'Please enter a valid 10-digit phone number';
            }
            break;

        case 'postal_code':
            const zipRegex = /^\d{5}(-\d{4})?$/;
            if (!zipRegex.test(field.value)) {
                isValid = false;
                errorMessage = 'Please enter a valid ZIP code (12345 or 12345-6789)';
            }
            break;

        case 'email':
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(field.value)) {
                isValid = false;
                errorMessage = 'Please enter a valid email address';
            }
            break;

        case 'address_line1':
            if (field.value.length < 5) {
                isValid = false;
                errorMessage = 'Please enter a valid street address';
            }
            break;

        case 'city':
            if (field.value.length < 2) {
                isValid = false;
                errorMessage = 'Please enter a valid city name';
            }
            break;

        case 'state':
            if (!field.value) {
                isValid = false;
                errorMessage = 'Please select a state';
            }
            break;

        default:
            if (field.required && !field.value.trim()) {
                isValid = false;
                errorMessage = 'This field is required';
            }
    }

    field.classList.toggle('is-invalid', !isValid);
    if (errorElement) {
        errorElement.textContent = errorMessage;
        errorElement.classList.toggle('show', !isValid);
    }

    return isValid;
}
    function setupInputFormatting() {
    // Phone number formatting
    const phoneInput = document.getElementById('phone');
    phoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 0) {
            if (value.length <= 3) {
                value = `(${value}`;
            } else if (value.length <= 6) {
                value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
            } else {
                value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6, 10)}`;
            }
        }
        e.target.value = value;
    });

    // ZIP code formatting
    const zipInput = document.getElementById('postal_code');
    zipInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 5) {
            value = value.slice(0, 5) + '-' + value.slice(5, 9);
        }
        e.target.value = value;
    });

    // Add input validation listeners
    const form = document.getElementById('shipping-form');
    const inputs = form.querySelectorAll('input, select');
    inputs.forEach(input => {
        input.addEventListener('blur', () => validateField(input));
    });
}
    document.addEventListener('DOMContentLoaded', function() {
        initializeSquare();
        document.getElementById('card-button').addEventListener('click', handlePayment);
        const stateSelect = document.getElementById('state');
    US_STATES.forEach(state => {
        const option = document.createElement('option');
        option.value = state.value;
        option.textContent = state.label;
        stateSelect.appendChild(option);
    });

    // Add input formatting
    setupInputFormatting();
    });
</script>
</body>
</html>

